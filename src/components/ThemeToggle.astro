<div class="relative inline-block" data-theme-toggle>
	<button
		type="button"
		data-theme-trigger
		aria-haspopup="menu"
		aria-expanded="false"
		class="p-2.5 rounded-xl bg-slate-100/50 dark:bg-white/5 text-slate-600 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-500/10 border border-slate-200/50 dark:border-white/5 transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500/50"
	>
		<span class="sr-only">Cambiar tema</span>
		<!-- Light Icon -->
		<svg
			data-theme-icon="light"
			class="w-5 h-5 transition-transform duration-300 group-hover:rotate-12"
			viewBox="0 0 24 24"
			fill="none"
			stroke="currentColor"
			stroke-width="2"
			stroke-linecap="round"
			stroke-linejoin="round"
		>
			<circle cx="12" cy="12" r="4"></circle>
			<path d="M12 2v2"></path>
			<path d="M12 20v2"></path>
			<path d="m4.93 4.93 1.41 1.41"></path>
			<path d="m17.66 17.66 1.41 1.41"></path>
			<path d="M2 12h2"></path>
			<path d="M20 12h2"></path>
			<path d="m6.34 17.66-1.41 1.41"></path>
			<path d="m19.07 4.93-1.41 1.41"></path>
		</svg>
		<!-- Dark Icon -->
		<svg
			data-theme-icon="dark"
			class="hidden w-5 h-5 transition-transform duration-300 group-hover:-rotate-12"
			viewBox="0 0 24 24"
			fill="none"
			stroke="currentColor"
			stroke-width="2"
			stroke-linecap="round"
			stroke-linejoin="round"
		>
			<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
		</svg>
		<!-- System Icon -->
		<svg
			data-theme-icon="system"
			class="hidden w-5 h-5"
			viewBox="0 0 24 24"
			fill="none"
			stroke="currentColor"
			stroke-width="2"
			stroke-linecap="round"
			stroke-linejoin="round"
		>
			<rect width="20" height="14" x="2" y="3" rx="2"></rect>
			<line x1="8" x2="16" y1="21" y2="21"></line>
			<line x1="12" x2="12" y1="17" y2="21"></line>
		</svg>
	</button>

	<div
		data-theme-menu
		class="absolute right-0 mt-3 z-50 hidden min-w-[120px] rounded-2xl border border-slate-200/60 dark:border-white/10 bg-white/90 dark:bg-[#0f0f0f]/90 backdrop-blur-2xl shadow-2xl shadow-indigo-500/10 p-1.5 animate-in fade-in zoom-in duration-200 origin-top-right"
	>
		<button
			type="button"
			data-theme-option="light"
			class="flex items-center gap-3 w-full text-left px-3 py-2.5 rounded-xl text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-indigo-500/10 hover:text-indigo-600 dark:hover:text-indigo-300 transition-all group"
		>
			<svg
				class="w-4 h-4"
				fill="none"
				viewBox="0 0 24 24"
				stroke="currentColor"
				stroke-width="2"
				><circle cx="12" cy="12" r="4"></circle><path
					d="M12 2v2m0 16v2m-7-17.1 1.4 1.4m11.2 11.2 1.4 1.4M2 12h2m16 0h2M6.3 17.7l-1.4 1.4M19.1 4.9l-1.4 1.4"
				></path></svg
			>
			Claro
		</button>
		<button
			type="button"
			data-theme-option="dark"
			class="flex items-center gap-3 w-full text-left px-3 py-2.5 rounded-xl text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-indigo-500/10 hover:text-indigo-600 dark:hover:text-indigo-300 transition-all group"
		>
			<svg
				class="w-4 h-4"
				fill="none"
				viewBox="0 0 24 24"
				stroke="currentColor"
				stroke-width="2"
				><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg
			>
			Oscuro
		</button>
		<button
			type="button"
			data-theme-option="system"
			class="flex items-center gap-3 w-full text-left px-3 py-2.5 rounded-xl text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-indigo-500/10 hover:text-indigo-600 dark:hover:text-indigo-300 transition-all group"
		>
			<svg
				class="w-4 h-4"
				fill="none"
				viewBox="0 0 24 24"
				stroke="currentColor"
				stroke-width="2"
				><rect width="20" height="14" x="2" y="3" rx="2"></rect><path
					d="M8 21h8m-4-4v4"></path></svg
			>
			Sistema
		</button>
	</div>
</div>

<script is:inline>
	(() => {
		const STORAGE_KEY = "theme";
		const THEMES = ["light", "dark", "system"];

		const getSavedTheme = () => {
			const value = localStorage.getItem(STORAGE_KEY);
			return THEMES.includes(value) ? value : "system";
		};

		const isDarkTheme = (theme) =>
			theme === "dark" ||
			(theme === "system" &&
				window.matchMedia("(prefers-color-scheme: dark)").matches);

		const applyTheme = (theme) => {
			document.documentElement.classList.toggle("dark", isDarkTheme(theme));
			document.documentElement.dataset.theme = theme;
		};

		const updateToggleState = (root, theme) => {
			root.querySelectorAll("[data-theme-icon]").forEach((icon) => {
				icon.classList.toggle(
					"hidden",
					icon.getAttribute("data-theme-icon") !== theme,
				);
			});

			root.querySelectorAll("[data-theme-option]").forEach((option) => {
				const selected = option.getAttribute("data-theme-option") === theme;
				option.classList.toggle("bg-indigo-500/10", selected);
				option.classList.toggle("text-indigo-600", selected);
				option.classList.toggle("dark:text-indigo-300", selected);
			});
		};

		const closeAllMenus = () => {
			document.querySelectorAll("[data-theme-menu]").forEach((menu) => {
				menu.classList.add("hidden");
				const trigger = menu.parentElement?.querySelector(
					"[data-theme-trigger]",
				);
				trigger?.setAttribute("aria-expanded", "false");
			});
		};

		const syncAllToggles = () => {
			const currentTheme = getSavedTheme();
			applyTheme(currentTheme);
			document.querySelectorAll("[data-theme-toggle]").forEach((toggle) => {
				updateToggleState(toggle, currentTheme);
			});
		};

		const initToggle = (root) => {
			if (root.dataset.themeToggleReady === "true") {
				updateToggleState(root, getSavedTheme());
				return;
			}

			root.dataset.themeToggleReady = "true";
			const trigger = root.querySelector("[data-theme-trigger]");
			const menu = root.querySelector("[data-theme-menu]");

			trigger?.addEventListener("click", (event) => {
				event.stopPropagation();
				const isHidden = menu?.classList.contains("hidden");
				closeAllMenus();
				if (isHidden) {
					menu?.classList.remove("hidden");
					trigger.setAttribute("aria-expanded", "true");
				}
			});

			root.querySelectorAll("[data-theme-option]").forEach((option) => {
				option.addEventListener("click", (event) => {
					event.stopPropagation();
					const nextTheme =
						option.getAttribute("data-theme-option") || "system";
					localStorage.setItem(STORAGE_KEY, nextTheme);
					syncAllToggles();
					closeAllMenus();
				});
			});

			updateToggleState(root, getSavedTheme());
		};

		const initThemeToggles = () => {
			document.querySelectorAll("[data-theme-toggle]").forEach((toggle) => {
				initToggle(toggle);
			});
			syncAllToggles();
		};

		if (!window.__themeToggleReady) {
			window.__themeToggleReady = true;

			document.addEventListener("click", closeAllMenus);
			document.addEventListener("keydown", (event) => {
				if (event.key === "Escape") closeAllMenus();
			});

			window
				.matchMedia("(prefers-color-scheme: dark)")
				.addEventListener("change", () => {
					if (getSavedTheme() === "system") {
						syncAllToggles();
					}
				});
		}

		initThemeToggles();
		document.addEventListener("astro:page-load", initThemeToggles);
		document.addEventListener("astro:after-swap", initThemeToggles);
	})();
</script>
