<div class="relative" data-theme-toggle>
	<button
		type="button"
		data-theme-trigger
		aria-haspopup="menu"
		aria-expanded="false"
		class="p-2 rounded-full bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-200 hover:ring-2 hover:ring-indigo-500 transition-all"
	>
		<span class="sr-only">Cambiar tema</span>
		<svg
			data-theme-icon="light"
			class="w-5 h-5"
			viewBox="0 0 24 24"
			fill="none"
			stroke="currentColor"
			stroke-width="1.8"
		>
			<circle cx="12" cy="12" r="4" />
			<path stroke-linecap="round" d="M12 2.5v2.2M12 19.3v2.2M4.7 4.7l1.6 1.6M17.7 17.7l1.6 1.6M2.5 12h2.2M19.3 12h2.2M4.7 19.3l1.6-1.6M17.7 6.3l1.6-1.6" />
		</svg>
		<svg
			data-theme-icon="dark"
			class="hidden w-5 h-5"
			viewBox="0 0 24 24"
			fill="none"
			stroke="currentColor"
			stroke-width="1.8"
		>
			<path
				stroke-linecap="round"
				stroke-linejoin="round"
				d="M21 12.8A8.9 8.9 0 1 1 11.2 3 7.2 7.2 0 0 0 21 12.8z"
			/>
		</svg>
		<svg
			data-theme-icon="system"
			class="hidden w-5 h-5"
			viewBox="0 0 24 24"
			fill="none"
			stroke="currentColor"
			stroke-width="1.8"
		>
			<rect x="3" y="4" width="18" height="12" rx="2" />
			<path stroke-linecap="round" d="M8 20h8M10 16v4M14 16v4" />
		</svg>
	</button>

	<div
		data-theme-menu
		class="absolute right-0 top-11 z-50 hidden min-w-[9rem] rounded-xl border border-slate-200 dark:border-slate-700 bg-white/95 dark:bg-[#111111]/95 shadow-xl shadow-slate-200/70 dark:shadow-none backdrop-blur-md p-1"
	>
		<button type="button" data-theme-option="light" class="theme-option w-full text-left px-3 py-2 rounded-lg text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">Claro</button>
		<button type="button" data-theme-option="dark" class="theme-option w-full text-left px-3 py-2 rounded-lg text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">Oscuro</button>
		<button type="button" data-theme-option="system" class="theme-option w-full text-left px-3 py-2 rounded-lg text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">Sistema</button>
	</div>
</div>

<script is:inline>
	(() => {
		const STORAGE_KEY = "theme";
		const THEMES = ["light", "dark", "system"];

		const getSavedTheme = () => {
			const value = localStorage.getItem(STORAGE_KEY);
			return THEMES.includes(value) ? value : "system";
		};

		const isDarkTheme = (theme) =>
			theme === "dark" ||
			(theme === "system" && window.matchMedia("(prefers-color-scheme: dark)").matches);

		const applyTheme = (theme) => {
			document.documentElement.classList.toggle("dark", isDarkTheme(theme));
			document.documentElement.dataset.theme = theme;
		};

		const updateToggleState = (root, theme) => {
			root.querySelectorAll("[data-theme-icon]").forEach((icon) => {
				icon.classList.toggle("hidden", icon.getAttribute("data-theme-icon") !== theme);
			});

			root.querySelectorAll("[data-theme-option]").forEach((option) => {
				const selected = option.getAttribute("data-theme-option") === theme;
				option.classList.toggle("bg-indigo-500/10", selected);
				option.classList.toggle("text-indigo-600", selected);
				option.classList.toggle("dark:text-indigo-300", selected);
			});
		};

		const closeAllMenus = () => {
			document.querySelectorAll("[data-theme-menu]").forEach((menu) => {
				menu.classList.add("hidden");
				const trigger = menu.parentElement?.querySelector("[data-theme-trigger]");
				trigger?.setAttribute("aria-expanded", "false");
			});
		};

		const syncAllToggles = () => {
			const currentTheme = getSavedTheme();
			applyTheme(currentTheme);
			document.querySelectorAll("[data-theme-toggle]").forEach((toggle) => {
				updateToggleState(toggle, currentTheme);
			});
		};

		const initToggle = (root) => {
			if (root.dataset.themeToggleReady === "true") {
				updateToggleState(root, getSavedTheme());
				return;
			}

			root.dataset.themeToggleReady = "true";
			const trigger = root.querySelector("[data-theme-trigger]");
			const menu = root.querySelector("[data-theme-menu]");

			trigger?.addEventListener("click", (event) => {
				event.stopPropagation();
				const isHidden = menu?.classList.contains("hidden");
				closeAllMenus();
				if (isHidden) {
					menu?.classList.remove("hidden");
					trigger.setAttribute("aria-expanded", "true");
				}
			});

			root.querySelectorAll("[data-theme-option]").forEach((option) => {
				option.addEventListener("click", (event) => {
					event.stopPropagation();
					const nextTheme = option.getAttribute("data-theme-option") || "system";
					localStorage.setItem(STORAGE_KEY, nextTheme);
					syncAllToggles();
					closeAllMenus();
				});
			});

			updateToggleState(root, getSavedTheme());
		};

		const initThemeToggles = () => {
			document.querySelectorAll("[data-theme-toggle]").forEach((toggle) => {
				initToggle(toggle);
			});
			syncAllToggles();
		};

		if (!window.__themeToggleReady) {
			window.__themeToggleReady = true;

			document.addEventListener("click", closeAllMenus);
			document.addEventListener("keydown", (event) => {
				if (event.key === "Escape") closeAllMenus();
			});

			window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
				if (getSavedTheme() === "system") {
					syncAllToggles();
				}
			});
		}

		initThemeToggles();
		document.addEventListener("astro:page-load", initThemeToggles);
		document.addEventListener("astro:after-swap", initThemeToggles);
	})();
</script>
